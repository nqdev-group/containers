# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# Workflow syntax for GitHub Actions
# ---------------------------------------------------
# https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

name: "GHCR Package Jenkins"
run-name: Build and Push Jenkins Docker Image on ${{ github.event_name }} by @${{ github.actor }}

on:
  workflow_dispatch: # Cho phÃ©p cháº¡y thá»§ cÃ´ng
  # push:
  # release:
  #   # created : # âœ… Chá»‰ cháº¡y khi release Ä‘Æ°á»£c táº¡o
  #   # published: # âœ… Chá»‰ cháº¡y khi release Ä‘Æ°á»£c phÃ¡t hÃ nh
  #   types: [published] # âœ… Chá»‰ cháº¡y khi release Ä‘Æ°á»£c phÃ¡t hÃ nh

# Remove all permissions by default
permissions: write-all

env:
  SERVER: production
  BRANCH: ${{ github.ref_name }}
  REPOSITORY: ${{ github.repository }}
  JENKINS_VERSION: 2.547
  VERSION: >-
    ${{
      github.ref_type == 'branch' && github.ref_name == 'main'
        && format('17.0.{0}-main', github.run_number)
        || github.ref_type == 'tag'
        && format('17.0.{0}', github.run_number)
        || format('17.0.{0}-dev', github.run_number)
    }}

jobs:
  docker-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Äáº·t biáº¿n VERSION dá»±a trÃªn ref_type vÃ  ref_name
      - name: Set VERSION
        run: |
          if [[ "${{ github.ref_type }}" == "branch" && "${{ github.ref_name }}" == "main" ]]; then
            echo "VERSION=${{ env.JENKINS_VERSION }}.${{ github.run_number }}-main" >> $GITHUB_ENV
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "VERSION=${{ env.JENKINS_VERSION }}.${{ github.run_number }}" >> $GITHUB_ENV
          else
            echo "VERSION=${{ env.JENKINS_VERSION }}.${{ github.run_number }}-dev" >> $GITHUB_ENV
          fi

      # 2. Checkout code tá»« repository
      - name: Checkout repository
        uses: actions/checkout@v6

      # 4. ÄÄƒng nháº­p vÃ o GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }} # GitHub token cáº§n thiáº¿t cho viá»‡c push image

      # 5. ÄÄƒng nháº­p vÃ o Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }} # Äáº£m báº£o thÃªm secret DOCKER_USERNAME vÃ o repository secrets
          password: ${{ secrets.DOCKER_TOKEN }} # Äáº£m báº£o thÃªm secret DOCKER_TOKEN vÃ o repository secrets

      # 6. XÃ¢y dá»±ng Docker image vá»›i file Dockerfile cá»¥ thá»ƒ
      - name: Build Docker Image
        run: |
          docker build --no-cache \
            --build-arg JENKINS_VERSION=${{ env.JENKINS_VERSION }} \
            -t ghcr.io/${{ github.repository_owner }}/jenkins:${{ env.VERSION }} \
            -t ghcr.io/${{ github.repository_owner }}/jenkins:latest \
            -t docker.io/${{ secrets.DOCKER_USERNAME }}/jenkins:${{ env.VERSION }} \
            -t docker.io/${{ secrets.DOCKER_USERNAME }}/jenkins:latest \
            -f ./nqdev/jenkins/debian/Dockerfile ./nqdev/jenkins/debian

      # 7. Äáº©y Docker Image lÃªn GitHub Container Registry
      # - name: Push Docker Image to GHCR
      #   run: |
      #     docker push ghcr.io/${{ github.repository_owner }}/jenkins:${{ env.VERSION }}
      #     docker push ghcr.io/${{ github.repository_owner }}/jenkins:latest

      # 8. Äáº©y Docker Image lÃªn Docker Hub
      - name: Push Docker Image to Docker Hub
        run: |
          docker push docker.io/${{ secrets.DOCKER_USERNAME }}/jenkins:${{ env.VERSION }}
          docker push docker.io/${{ secrets.DOCKER_USERNAME }}/jenkins:latest

      # ğŸŸ¢ Annotation khi thÃ nh cÃ´ng
      - name: Show success annotation
        if: success()
        run: |
          echo "::notice::âœ… Docker image pushed successfully!"
          echo "::notice file=nqdev/jenkins/debian/Dockerfile,line=1::ğŸ“¦ Image version: ${{ env.VERSION }}"
          echo "::notice::ğŸ”— GHCR: ghcr.io/${{ github.repository_owner }}/jenkins:${{ env.VERSION }}"
          echo "::notice::ğŸ”— Docker Hub: docker.io/${{ secrets.DOCKER_USERNAME }}/jenkins:${{ env.VERSION }}"

      # ğŸ”´ Annotation khi tháº¥t báº¡i
      - name: Show error annotation
        if: failure()
        run: |
          echo "::error::âŒ Build or push failed for version ${{ env.VERSION }}"
          echo "::error file=nqdev/jenkins/debian/Dockerfile,line=1::Check build logs for details."
