# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# Workflow syntax for GitHub Actions
# ---------------------------------------------------
# https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

name: "GHCR Package NGINX"
run-name: Build and Push Nginx Docker Image on ${{ github.event_name }} by @${{ github.actor }}

on:
  workflow_dispatch: # Cho ph√©p k√≠ch ho·∫°t th·ªß c√¥ng
    inputs:
      subversion:
        description: "SubVersion"
        required: false
        type: string

# Remove all permissions by default
permissions: write-all

env:
  SERVER: production
  PREFIX: "1.0"
  VERSION: "1.0.${{ github.run_number }}"

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1. ƒê·ªãnh nghƒ©a gi√° tr·ªã prefix
      - name: Define Prefix
        id: prefix
        run: |
          echo "PREFIX=1.0" >> $GITHUB_ENV # ƒê·∫∑t gi√° tr·ªã prefix phi√™n b·∫£n

      # 2. Checkout code t·ª´ repository
      - name: Checkout repository
        uses: actions/checkout@v5

      # 3. Thi·∫øt l·∫≠p s·ªë version t·ª± ƒë·ªông
      - name: Set Build Version
        id: versioning
        run: |
          # Ki·ªÉm tra s·ªë build hi·ªán t·∫°i t·ª´ GitHub Run Number
          BUILD_NUMBER=${{ github.run_number }}
          echo "VERSION=${{ env.PREFIX }}.${BUILD_NUMBER}" >> $GITHUB_ENV

      # 4. ƒêƒÉng nh·∫≠p v√†o GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }} # GitHub token c·∫ßn thi·∫øt cho vi·ªác push image

      # 5. X√¢y d·ª±ng Docker image v·ªõi file Dockerfile c·ª• th·ªÉ
      - name: Build Docker Image
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/nqdev-nginx-alpine-custom:${{ env.VERSION }} \
                       -t ghcr.io/${{ github.repository_owner }}/nqdev-nginx-alpine-custom:latest \
                       -f ./nqdev/nginx/1.27.2/alpine-custom/Dockerfile ./nqdev/nginx/1.27.2/alpine-custom

      # 6. ƒê·∫©y Docker image l√™n GitHub Container Registry
      - name: Push Docker Image
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/nqdev-nginx-alpine-custom:${{ env.VERSION }}
          docker push ghcr.io/${{ github.repository_owner }}/nqdev-nginx-alpine-custom:latest

      # üü¢ Annotation khi th√†nh c√¥ng
      - name: Show success annotation
        if: success()
        run: |
          echo "::notice::‚úÖ Docker image pushed successfully!"
          echo "::notice file=nqdev/wordpress/6/debian-12/Dockerfile,line=1::üì¶ Image version: ${{ env.VERSION }}"
          echo "::notice::üîó GHCR: ghcr.io/${{ github.repository_owner }}/wordpress:${{ env.VERSION }}"
          echo "::notice::üîó Docker Hub: docker.io/${{ secrets.DOCKER_USERNAME }}/wordpress:${{ env.VERSION }}"

      # üî¥ Annotation khi th·∫•t b·∫°i
      - name: Show error annotation
        if: failure()
        run: |
          echo "::error::‚ùå Build or push failed for version ${{ env.VERSION }}"
          echo "::error file=nqdev/nginx/1.27.2/alpine-custom/Dockerfile,line=1::Check build logs for details."
