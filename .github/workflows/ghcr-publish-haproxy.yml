# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# Workflow syntax for GitHub Actions
# ---------------------------------------------------
# https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

name: "GHCR Package HAProxy"
run-name: Build and Push HAProxy Docker Image on ${{ github.event_name }} by @${{ github.actor }}

on:
  workflow_dispatch: # Cho ph√©p k√≠ch ho·∫°t th·ªß c√¥ng
    inputs:
      subversion:
        description: "SubVersion"
        required: false
        type: string

# Remove all permissions by default
permissions: write-all

env:
  SERVER: production
  PREFIX: "3.1.5"
  VERSION: "3.1.5-rc${{ github.run_number }}"

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1. ƒê·ªãnh nghƒ©a gi√° tr·ªã prefix
      - name: Define Prefix
        id: prefix
        run: |
          echo "PREFIX=3.1.5" >> $GITHUB_ENV # ƒê·∫∑t gi√° tr·ªã prefix phi√™n b·∫£n

      # 2. Checkout code t·ª´ repository
      - name: Checkout repository
        uses: actions/checkout@v6

      # 3. Thi·∫øt l·∫≠p s·ªë version t·ª± ƒë·ªông
      - name: Set Build Version
        id: versioning
        run: |
          # Ki·ªÉm tra s·ªë build hi·ªán t·∫°i t·ª´ GitHub Run Number
          BUILD_NUMBER=${{ github.run_number }}
          echo "VERSION=${{ env.PREFIX }}-rc${BUILD_NUMBER}" >> $GITHUB_ENV

      # 4. ƒêƒÉng nh·∫≠p v√†o GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }} # GitHub token c·∫ßn thi·∫øt cho vi·ªác push image

      # 5. ƒêƒÉng nh·∫≠p v√†o Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }} # ƒê·∫£m b·∫£o th√™m secret DOCKER_USERNAME v√†o repository secrets
          password: ${{ secrets.DOCKER_TOKEN }} # ƒê·∫£m b·∫£o th√™m secret DOCKER_TOKEN v√†o repository secrets

      # 6. X√¢y d·ª±ng Docker image v·ªõi file Dockerfile c·ª• th·ªÉ
      - name: Build Docker Image
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/haproxy-alpine-custom:${{ env.VERSION }} \
                       -t ghcr.io/${{ github.repository_owner }}/haproxy-alpine-custom:latest \
                       -t docker.io/${{ secrets.DOCKER_USERNAME }}/haproxy-alpine-custom:${{ env.VERSION }} \
                       -t docker.io/${{ secrets.DOCKER_USERNAME }}/haproxy-alpine-custom:latest \
                       -f ./nqdev/haproxy/alpine/Dockerfile ./nqdev/haproxy/alpine

      # 7. ƒê·∫©y Docker Image l√™n GitHub Container Registry
      - name: Push Docker Image to GHCR
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/haproxy-alpine-custom:${{ env.VERSION }}
          docker push ghcr.io/${{ github.repository_owner }}/haproxy-alpine-custom:latest

      # 8. ƒê·∫©y Docker Image l√™n Docker Hub
      - name: Push Docker Image to Docker Hub
        run: |
          docker push docker.io/${{ secrets.DOCKER_USERNAME }}/haproxy-alpine-custom:${{ env.VERSION }}
          docker push docker.io/${{ secrets.DOCKER_USERNAME }}/haproxy-alpine-custom:latest

      # üü¢ Annotation khi th√†nh c√¥ng
      - name: Show success annotation
        if: success()
        run: |
          echo "::notice::‚úÖ Docker image pushed successfully!"
          echo "::notice file=nqdev/wordpress/6/debian-12/Dockerfile,line=1::üì¶ Image version: ${{ env.VERSION }}"
          echo "::notice::üîó GHCR: ghcr.io/${{ github.repository_owner }}/wordpress:${{ env.VERSION }}"
          echo "::notice::üîó Docker Hub: docker.io/${{ secrets.DOCKER_USERNAME }}/wordpress:${{ env.VERSION }}"

      # üî¥ Annotation khi th·∫•t b·∫°i
      - name: Show error annotation
        if: failure()
        run: |
          echo "::error::‚ùå Build or push failed for version ${{ env.VERSION }}"
          echo "::error file=nqdev/haproxy/alpine/Dockerfile,line=1::Check build logs for details."
