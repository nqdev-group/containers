# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# Workflow syntax for GitHub Actions
# ---------------------------------------------------
# https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

name: "GHCR Package PostgreSQL pgAgent"
run-name: Build and Push PostgreSQL with pgAgent, pgsql-http Docker Image on ${{ github.event_name }} by @${{ github.actor }}

on:
  workflow_dispatch: # Cho phÃ©p cháº¡y thá»§ cÃ´ng
  # push:
  # release:
  #   # created : # âœ… Chá»‰ cháº¡y khi release Ä‘Æ°á»£c táº¡o
  #   # published: # âœ… Chá»‰ cháº¡y khi release Ä‘Æ°á»£c phÃ¡t hÃ nh
  #   types: [published] # âœ… Chá»‰ cháº¡y khi release Ä‘Æ°á»£c phÃ¡t hÃ nh

# Remove all permissions by default
permissions: write-all

env:
  SERVER: production
  BRANCH: ${{ github.ref_name }}
  REPOSITORY: ${{ github.repository }}
  VERSION: >-
    ${{
      github.ref_type == 'branch' && github.ref_name == 'main'
        && format('17.5.{0}-main', github.run_number)
        || github.ref_type == 'tag'
        && format('17.5.{0}', github.run_number)
        || format('17.5.{0}-dev', github.run_number)
    }}

jobs:
  docker-deploy:
    runs-on: ubuntu-latest

    steps:
      # 2. Checkout code tá»« repository
      - name: Checkout repository
        uses: actions/checkout@v5

      # 4. ÄÄƒng nháº­p vÃ o GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }} # GitHub token cáº§n thiáº¿t cho viá»‡c push image

      # 5. ÄÄƒng nháº­p vÃ o Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }} # Äáº£m báº£o thÃªm secret DOCKER_USERNAME vÃ o repository secrets
          password: ${{ secrets.DOCKER_TOKEN }} # Äáº£m báº£o thÃªm secret DOCKER_TOKEN vÃ o repository secrets

      # 6. XÃ¢y dá»±ng Docker image vá»›i file Dockerfile cá»¥ thá»ƒ
      - name: Build Docker Image
        run: |
          docker build --no-cache \
            -t ghcr.io/${{ github.repository_owner }}/postgres-pgagent:${{ env.VERSION }} \
            -t ghcr.io/${{ github.repository_owner }}/postgres-pgagent:latest \
            -t docker.io/${{ secrets.DOCKER_USERNAME }}/postgres-pgagent:${{ env.VERSION }} \
            -t docker.io/${{ secrets.DOCKER_USERNAME }}/postgres-pgagent:latest \
            -f ./nqdev/postgres-pgagent/Dockerfile ./nqdev/postgres-pgagent

      # 7. Äáº©y Docker Image lÃªn GitHub Container Registry
      - name: Push Docker Image to GHCR
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/postgres-pgagent:${{ env.VERSION }}
          docker push ghcr.io/${{ github.repository_owner }}/postgres-pgagent:latest

      # 8. Äáº©y Docker Image lÃªn Docker Hub
      - name: Push Docker Image to Docker Hub
        run: |
          docker push docker.io/${{ secrets.DOCKER_USERNAME }}/postgres-pgagent:${{ env.VERSION }}
          docker push docker.io/${{ secrets.DOCKER_USERNAME }}/postgres-pgagent:latest

      # ğŸŸ¢ Annotation khi thÃ nh cÃ´ng
      - name: Show success annotation
        if: success()
        run: |
          echo "::notice::âœ… Docker image pushed successfully!"
          echo "::notice file=nqdev/wordpress/6/debian-12/Dockerfile,line=1::ğŸ“¦ Image version: ${{ env.VERSION }}"
          echo "::notice::ğŸ”— GHCR: ghcr.io/${{ github.repository_owner }}/wordpress:${{ env.VERSION }}"
          echo "::notice::ğŸ”— Docker Hub: docker.io/${{ secrets.DOCKER_USERNAME }}/wordpress:${{ env.VERSION }}"

      # ğŸ”´ Annotation khi tháº¥t báº¡i
      - name: Show error annotation
        if: failure()
        run: |
          echo "::error::âŒ Build or push failed for version ${{ env.VERSION }}"
          echo "::error file=nqdev/postgres-pgagent/Dockerfile,line=1::Check build logs for details."
